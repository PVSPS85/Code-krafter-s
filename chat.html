{% extends "base.html" %}
{% block title %}Group Chat{% endblock %}
{% block content %}
<style>
.chat-main {
  max-width: 540px; margin: 38px auto 24px; 
  background: var(--bg-light);
  border-radius: 18px; 
  box-shadow: 0 10px 38px #0099cc1f;
  padding: 28px 28px 20px;
}
.chat-head {
  display: flex; align-items: center; gap: 10px;
}
.chat-head i { font-size:2.1rem;color:#0099cc; }
.chat-head span { font-size:1.21rem;font-weight:700;color:var(--primary); }
#messages {
  background: var(--bg-white); border-radius: 10px;
  padding: 15px 15px 10px; min-height: 150px; max-height: 235px; overflow-y: auto;
  box-shadow: 0 2px 11px #21808d11;
}
.bubble { display: flex; align-items: flex-end; gap: 8px; margin-bottom: 7px; }
.bubble-user { background: var(--primary); color: #fff; font-weight: 600; padding: 5px 12px; border-radius: 14px; font-size: 0.99rem; min-width: 80px; text-align: right; box-shadow: 0 1px 6px #21808d11; }
.bubble-me { background: var(--danger); }
.bubble-msg { background: var(--primary-light); color: #23263a; padding: 6px 16px; border-radius: 15px 16px 16px 5px; font-size: 1.05rem; font-weight: 450; max-width: 290px; word-break: break-word; }
#myMessage { border-radius: 10px; border: 1px solid var(--border); padding: 10px 18px; margin-top: 2px; font-size:1.05rem; background:var(--bg-white);}
@media (max-width:650px) {.chat-main{max-width:98vw;padding:18px 6vw;}#messages{max-width:98vw;}}
</style>
<div class="chat-main">
  <div class="chat-head">
    <i class="fas fa-comments"></i>
    <span>Group Chat</span>
  </div>
  <ul id="messages"></ul>
  <input id="myMessage" autocomplete="off" placeholder="Type a message...">
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.6.1/socket.io.min.js"></script>
<script>
var socket = io({transports: ["websocket", "polling"]}); // Ensure websocket or polling transport
var input = document.getElementById('myMessage');
var messages = document.getElementById('messages');
var currentUser = "{{ user['name'] if user and user['name'] else 'Anonymous' }}";

input.addEventListener('keyup', function (e) {
    if (e.key === "Enter" && input.value.trim().length > 0) {
        socket.send(currentUser + ":" + input.value);
        input.value = "";
    }
});
socket.on('message', function (msg) {
    var parts = msg.split(":");
    var user = parts[0] ? parts[0].trim() : "User";
    var text = parts.slice(1).join(":");
    var li = document.createElement('li');
    li.className = "bubble";
    var userSpan = document.createElement('span');
    userSpan.className = "bubble-user" + (user === currentUser ? " bubble-me" : "");
    userSpan.textContent = user;
    var msgSpan = document.createElement('span');
    msgSpan.className = "bubble-msg";
    msgSpan.textContent = text;
    li.appendChild(userSpan);
    li.appendChild(msgSpan);
    messages.appendChild(li);
    messages.scrollTop = messages.scrollHeight;
});
</script>
{% endblock %}
